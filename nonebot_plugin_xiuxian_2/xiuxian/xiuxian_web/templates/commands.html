{% extends "base.html" %}

{% block content %}
    <div class="card">
        <h2>管理员指令</h2>
        
        <div style="margin-top: 20px;">
            {% for cmd_name, cmd_info in commands.items() %}
                <div class="card command-form" style="margin-bottom: 20px;">
                    <h3>{{ cmd_info.name }}</h3>
                    <p>{{ cmd_info.description }}</p>
                    
                    <form class="command-execute-form" data-command="{{ cmd_name }}">
                        {% for param in cmd_info.params %}
                            {% if param.type == "select" %}
                                <div class="form-group">
                                    <label for="{{ cmd_name }}_{{ param.key }}">{{ param.name }}</label>
                                    <select id="{{ cmd_name }}_{{ param.key }}" name="{{ param.key }}" class="param-select" 
                                        {% if param.get('show_if') %}data-show-if="{{ param.show_if|tojson|forceescape }}"{% endif %}>
                                        {% for option in param.options %}
                                            {% if param.options is mapping %}
                                                <option value="{{ option }}">{{ param.options[option] }}</option>
                                            {% else %}
                                                <option value="{{ option }}">{{ option }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            {% else %}
                                <div class="form-group" 
                                    {% if param.get('show_if') %}data-show-if="{{ param.show_if|tojson|forceescape }}"{% endif %}>
                                    <label for="{{ cmd_name }}_{{ param.key }}">{{ param.name }}</label>
                                    <input type="{{ param.type }}" id="{{ cmd_name }}_{{ param.key }}" name="{{ param.key }}" 
                                        {% if param.required %}required{% endif %}>
                                </div>
                            {% endif %}
                        {% endfor %}
                        
                        <button type="button" onclick="executeCommand('{{ cmd_name }}')" class="btn">执行</button>
                    </form>
                    
                    <div id="{{ cmd_name }}_result" class="command-result" style="display: none;"></div>
                </div>
            {% endfor %}
        </div>
    </div>
    
    <script>
        // 动态显示/隐藏表单字段
        document.querySelectorAll('.param-select').forEach(select => {
            select.addEventListener('change', function() {
                const showIf = this.dataset.showIf;
                if (showIf) {
                    const conditions = JSON.parse(showIf);
                    const parentForm = this.closest('.command-execute-form');
                    
                    Object.keys(conditions).forEach(key => {
                        const value = conditions[key];
                        const shouldShow = this.value === value;
                        
                        parentForm.querySelectorAll(`[data-show-if*="${key}"]`).forEach(el => {
                            if (el !== this) {
                                el.style.display = shouldShow ? 'block' : 'none';
                                if (!shouldShow) {
                                    el.querySelector('input, select').value = '';
                                }
                            }
                        });
                    });
                }
            });
            
            // 触发初始状态
            select.dispatchEvent(new Event('change'));
        });
        
        // 执行命令
        function executeCommand(cmdName) {
            const form = document.querySelector(`.command-execute-form[data-command="${cmdName}"]`);
            const resultDiv = document.getElementById(`${cmdName}_result`);
            const formData = new FormData(form);
            const data = {command_name: cmdName};
            
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            resultDiv.style.display = 'none';
            
            fetch("{{ url_for('execute_command') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                resultDiv.style.display = 'block';
                if (result.success) {
                    resultDiv.innerHTML = `<div class="success">${result.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">${result.error}</div>`;
                }
            })
            .catch(error => {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<div class="error">请求失败: ${error}</div>`;
            });
        }
    </script>
{% endblock %}
